<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' https://unpkg.com;">
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <title>Document</title>
    <style>
        :root {
            --UI-height: 5%;
        }
        * {
            margin: 0;
            box-sizing: border-box;
        }
        html, body {
            height: 100%;
        }
        #main_container {
            height: 100%;
        }
        #systemUI {
            border: dashed;
            height: var(--UI-height);
        }
        #game_container {
            width: 100%;
            height: calc(100% - var(--UI-height));
            border: solid;
        }
        #canvas {
            display: block;
        }
    </style>
</head>
<body>
    <div id="main_container">
        <div id="systemUI"></div>
        <div id="game_container">
            <canvas id="canvas"></canvas>
        </div>
    </div>
    <script>
        class Player {
            constructor(session_id, r, c, color) {
                this.session_id = session_id;
                this.r = r;
                this.c = c;
                this.color = color;
            }
        }
        var myPlayer;
        var playerIdSet = new Set();
        var playerInfo = {}

        var keyPress = {
            horizontal: 0,
            vertical: 0,
        }
        var charcter_speed=10;

        var canvas = document.getElementById("canvas");
        canvas.width = game_container.clientWidth;
        canvas.height = game_container.clientHeight;
        context = canvas.getContext("2d");

        
    </script>

    <script>
        // var host_url = window.versions.host();
        // var socket_url = window.versions.socket();
        var host_url = "http://localhost:9999/api"
        var socket_url = "ws://localhost:9999/api/socket"
        // var host_url = "https://minesweeping.duckdns.org/api"
        // var socket_url = "wss://minesweeping.duckdns.org/api/socket"

        // console.log(host_url);
        // console.log(socket_url);
        var socket_init = () => {
            var conn = new WebSocket(socket_url);
            var socket_send = (message) => {
                conn.send(JSON.stringify(message));
            }
            conn.onmessage = async (msg) => {
                var dto = JSON.parse(msg.data);
                console.log(dto);
                var code = dto.code;
                var value = dto.value;
                if (code == "ping") {
                    console.log("핑을 받았어요, 퐁을 보낼게요");
                    socket_send({event: "pong", data: {id: myPlayer.session_id}});
                }
                else if (code == "my_session_id") {
                    console.log("내 세션 아이디는 : ", value.my_session_id);
                    myPlayer = new Player(value.my_session_id, canvas.width/2, canvas.height/2, "green");
                    socket_send({event: "new_player", data: {id: myPlayer.session_id, r: myPlayer.r, c: myPlayer.c}});
                } else if (code == "new_player") {
                    console.log("새 플레이어");
                    playerIdSet.add(value.session_id);
                    playerInfo[value.session_id] = new Player(value.session_id, value.r, value.c, "blue");
                    socket_send({event: "welcome_you", data: {id: value.session_id, r: myPlayer.r, c: myPlayer.c}});
                } else if (code == "take_position") {
                    console.log("친구 정보 : ", value)
                    playerIdSet.add(value.session_id);
                    playerInfo[value.session_id] = new Player(value.session_id, value.r, value.c, "blue")
                } else if (code == "player_disconnect") {
                    console.log("끊긴 친구 정보 : ", value);
                    playerIdSet.delete(value.id);
                    delete playerInfo[value.id]
                }
            }
            conn.onopen = async () => {
                console.log("연결 성공!");
                var mineBoard;
                await axios.get(host_url + '/mineBoard').then((r) => {
                    mineBoard = r.data;
                    console.log(r.data)
                });
                draw = () => {
                    // console.log("그릴게요!" + playerIdSet.size);
                    context.clearRect(0, 0, canvas.width, canvas.height);
                    
                    var block_width = canvas.width / mineBoard[0].length;
                    var block_height = canvas.height / mineBoard.length;
                    
                    for (let i = 0; i < mineBoard.length; i++) {
                        for (let j = 0; j < mineBoard[i].length; j++) {
                            // console.log(i, j);
                            if (i % 10 == 4 || i % 10 == 9 || j % 10 == 4 || j % 10 == 9) context.fillStyle = "red";
                            else context.fillStyle = "black";
                            context.fillRect(j * block_width+1, i*block_height+1, block_width-2, block_height-2)
                        }
                    }
                    for (let i of playerIdSet) {
                        context.beginPath();
                        context.arc(playerInfo[i].r, playerInfo[i].c, 10, 0, Math.PI * 2);
                        context.fillStyle = playerInfo[i].color;
                        context.fill();
                    }

                    myPlayer.r += keyPress.horizontal * charcter_speed;
                    myPlayer.c += keyPress.vertical * charcter_speed;
                    console.log(myPlayer.r, myPlayer.c);
                    context.beginPath();
                    context.arc(myPlayer.r, myPlayer.c, 10, 0, Math.PI * 2);
                    context.fillStyle = myPlayer.color;
                    context.fill();
                    requestAnimationFrame(draw);
                }
                draw();
            }
            
            conn.onclose = () => {
                console.log("연결 끊어짐ㅜㅜ");

                setTimeout(function() {
                    socket_init();
                }, 500);
            }
        }
        socket_init();

        document.addEventListener("keydown", (event) => {
            if (event.key === "ArrowRight") {
                if (keyPress.horizontal == 1) return;
                keyPress.horizontal += 1;
            } else if (event.key === "ArrowLeft") {
                if (keyPress.horizontal == -1) return;
                keyPress.horizontal -= 1;
            } else if (event.key === "ArrowUp") {
                if (keyPress.vertical == -1) return;
                keyPress.vertical -= 1;
            } else if (event.key === "ArrowDown") {
                if (keyPress.vertical == 1) return;
                keyPress.vertical += 1;
            } 
        });
        document.addEventListener("keyup", (event) => {
            if (event.key === "ArrowRight") {
                keyPress.horizontal -= 1;
            } else if (event.key === "ArrowLeft") {
                keyPress.horizontal += 1;
            } else if (event.key === "ArrowUp") {
                keyPress.vertical += 1;
            } else if (event.key === "ArrowDown") {
                keyPress.vertical -= 1;
            } 
        });
        
    </script>
</body>
</html>